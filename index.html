<html>
<head>
  <meta charset="UTF-8" />
  <title>Uplift Swineland Plots</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <script src="cacheduplifts.js"></script>
  <!-- for testing <script src="testdata.js"></script> -->
  <style>
      #image-map {
          background: black;
          width: 100%;
          position: absolute;
          top: 3em; 
          bottom: 0;
      }
      #menu-bar {
          width: 100%;
          height: 3em;
          text-align: center;
      }
      #mapchoice {
          margin-right: 3em;
      }
      #lastsale {
          margin-left: 3em;
      }
      #nextsale {
          margin-left: 3em;
      }
      #saletimer {
          font-size: smaller;
      }
      .number-label {
          font-weight: bold;
          font-size: 2em;
          font-color: #00ff00;
          -webkit-text-fill-color: #00ff00;
          -webkit-text-stroke: 1px black;
      }
      body {
          margin-left: 0px;
          font-family:'Roboto',sans-serif;
      }
  </style>
  <script>
      var plots = new Array();
      var owners = new Object();
      var gridlines = new Array();
      var last_sale_date = 0;
      var show_next = null;
      var sale_timer;
      var next_uplift = null;
      var showingNeighbors = new Array();
      
	  //const api_server = 'wax.greymass.com'
	  //const api_server = 'wax.cryptolions.io'
      const api_server = 'api.waxsweden.org'
      
      const map_offset_left = 24.0,
          map_offset_top = 23.1,
          plot_height = 25.0,
          plot_width = 25.03;
      
      function fetchNFTs() {
          var url = "https://wax.api.atomicassets.io/atomicassets/v1/assets?collection_name=rplanet&schema_name="
              + ((land == 'swine') ? 'lands' : 'lands2') + "&page=1&limit=2000&mutable_data.uplift_world="
              + ((land == 'swine') ? 'Swineland' : 'Boarvallis');
          console.log(url);
		  fetch(url).then(response => response.json())
          .then(data => processData(data.data))
	  	  .catch(error => {
              document.getElementById('menu-bar').innerHTML = 'Failed to fetch data from Atomic Assest API. Try again when they fix their shit. (' + error + ')';
	  	  });
      }
      
      async function fetchLastUplift() {
          var deltas;
		  await fetch("https://" + api_server + "/v2/history/get_deltas?code=l.rplanet&scope=" + ((land == 'swine') ? 'l.rplanet' : 'boarvallis') + "&table=uplift")
		  .then(response => response.json())
          .then(data => deltas = data.deltas)
	  	  .catch(error => {
              console.log('Failed to fetch data from Cryptolions API - ' + error);
	  	  });
          processNew(deltas);
      }

      function fetchUplifts() {
		  fetch("https://" + api_server + "/v1/chain/get_table_rows", {
		    "headers": {
		      "accept": "*/*",
		      "accept-language": "en-US,en;q=0.9",
		      "content-type": "text/plain;charset=UTF-8",
		      "sec-ch-ua": "\"Google Chrome\";v=\"89\", \"Chromium\";v=\"89\", \";Not A Brand\";v=\"99\"",
		      "sec-ch-ua-mobile": "?0",
		      "sec-fetch-dest": "empty",
		      "sec-fetch-mode": "cors",
		      "sec-fetch-site": "cross-site"
		    },
		    "referrerPolicy": "strict-origin-when-cross-origin",
		    "body": '{"json":true,"code":"l.rplanet","scope":"boarvallis","table":"uplift","lower_bound":"14173392078600","upper_bound":"","index_position":1,"key_type":"","limit":6000,"reverse":false,"show_payer":false}',
		    "method": "POST",
		    "mode": "cors",
		    "credentials": "omit" })
		  .then(response => response.json())
          .then(data => console.log(data))
	  	  .catch(error => {
              document.getElementById('menu-bar').innerHTML = 'Failed to fetch data for new sales. Try again when WAX fixes their shit. (' + error + ')';
	  	  });
      }

      String.prototype.proper = function() {
          return this.charAt(0).toUpperCase() + this.slice(1);
      }
      
      window.onload = async function() {
          fetchNFTs();
          // for testing
          //processData(raw_asset.data);
      };
      
      function highlightOwner(owner) {
          window.history.replaceState({ additionalInformation: 'Filter for owner' }, 'Uplift Swineland Plots', window.location.href.split('?')[0] + ((owner == '') ? '' : '?owner=' + encodeURIComponent(owner)) + ((land == 'swine') ? '' : ((owner == '') ? '?' : '&') + 'land=boar'));
          document.getElementById('owner').value = owner
          for (let x = 1; x < plots.length; x++) {
              if (typeof plots[x] != 'undefined') {
                  for (let y = 1; y < plots[x].length; y++) {
                       if (typeof plots[x][y] != 'undefined') {
                           if (plots[x][y].owner == owner) {
                               gridlines[x][y].setStyle({ color: "#ffff00" }).bringToFront();
                           } else {
                               gridlines[x][y].setStyle({ color: "#000000" }).bringToBack();
                           }
                       }
                   }
               }
           }
      }
      
      function timeSince(date) {
          var seconds = Math.floor((new Date() - last_sale_date) / 1000);
          var interval = seconds / 31536000;
          var msg = Math.floor(interval) + " years ago";
          if (interval <= 1) {
              interval = seconds / 2592000;
              if (interval > 1) {
                msg = Math.floor(interval) + " months ago";
              } else {
                  interval = seconds / 86400;
                  if (interval > 1) {
                    msg = Math.floor(interval) + " days ago";
                  } else {
                      interval = seconds / 3600;
                      if (interval > 1) {
                        msg = Math.floor(interval) + " hours ago";
                      } else {
                          interval = seconds / 60;
                          if (interval > 1) {
                            msg = Math.floor(interval) + " minutes ago";
                          } else {
                              msg = "Less that 1 minute ago";
                          }
                      }
                  }
              }
          }
          document.getElementById('saletimer').innerHTML = '&nbsp;(' + msg + ')';
      }
      
      function locationToGrid(location) {
          location = parseInt(location);
          let y = Math.floor(location / 214748364800);
          let x = (location - y * 214748364800) / 50;
          return {x: x, y: y};
      }
      
      function gridToLocation(grid) {
          return (grid.y * 50 * 214748364800) / 50 + (grid.x * 50);
      }
      
      function gridToMap(grid) {
          let xx = (grid.x - 1) * plot_width + map_offset_left;
          let yy = (79 - grid.y) * plot_width + map_offset_top;
          return {x: xx, y: yy};
      }
      
      function highlightGrid(grid, color, number, poptext, offset=true) {
          let mapcord = gridToMap(grid)
          let opacity = (color === null) ? 0.0 : 1.0;
          let fillOpacity = (color === null) ? 0.0 : 0.2;
          if( typeof gridlines[grid.x] == 'undefined' ) gridlines[grid.x] = new Array();
          if( typeof gridlines[grid.x][grid.y] == 'undefined' )
              gridlines[grid.x][grid.y] = L.rectangle([[mapcord.y, mapcord.x],[mapcord.y+plot_width, mapcord.x+plot_width]], {color: color, weight: 5, opacity: opacity, fillOpacity: fillOpacity}).bindPopup(poptext).addTo(map);
          else
              gridlines[grid.x][grid.y].setStyle({ color: color, weight: 5, opacity: opacity, fillOpacity: fillOpacity });

          if (color != null) {
              var myIcon = L.divIcon({className: 'number-label', html: number});
              let x = (offset) ? mapcord.x + plot_width + 5 : mapcord.x + 10;
              let y = (offset) ? mapcord.y + plot_width + 10 : mapcord.y + 10;
              L.marker([y, x], {icon: myIcon}).addTo(markerGroup);
          }
      }
      
      function panTo(grid) {
          let mapcord = gridToMap(grid);
          map.panTo(new L.LatLng(mapcord.y, mapcord.x));
      }
      
      function panHighlight(grid) {
          highlightOwner('');
          gridlines[grid.x][grid.y].setStyle({ color: "#ffff00" }).bringToFront();
          panTo(grid)
      }
      
      function processNew(data) {
          var html = "";
          last_sale_date = new Date(data[0].timestamp + 'Z');
          let grid = locationToGrid(data[0].data.loc);
          html += 'Newest: <a href="javascript:panHighlight({x:' + grid.x + ', y:' + grid.y +'})">' + (grid.x * 50) + ':' + (grid.y * 50) + '</a>';
          document.getElementById('lastsale').innerHTML = html;
          timeSince();
          sale_timer = setInterval(timeSince, 10000);
          
          next_uplift = data[0].data.order;
          
          showFuturePlots(true);
      }
      
      function showNeighbors(grid) {
          showingNeighbors.push(grid);
          for (let x = (grid.x - 1); x <= (grid.x + 1); x++) {
              for (let y = (grid.y - 1); y <= (grid.y + 1); y++) {
                  if (typeof plots[x] != 'undefined' && typeof plots[x][y] != 'undefined')
                      continue;
                  let found = cached_uplifts.find( ({ loc }) => loc == gridToLocation({x: x,y: y}) );
                  if (typeof found == 'undefined')
                      continue;
                  
                  let poptext = 'Available after ' + (found.order - next_uplift) + ' Uplifts.<br>'
                      + 'Location: ' + (x * 50) + ':' + (y * 50) + '<br>'
                      + '<a href="https://worldmaps.theuplift.world/' + ((land == 'swine') ? 'Swineland#Swineland' : 'Boarvallis#Boarvallis') + ';flat;' + (x * 50 + 25) + ',64,' + (y * 50 + 25) + ';6">Live Map</a><br>';
                  highlightGrid({x: x, y: y}, '#bbff00', (found.order - next_uplift), poptext, false);
              }
          }
      }
      
      function hideNeighbors() {
          for (let i = 0; i < showingNeighbors.length; i++) {
              let grid = showingNeighbors[i];
              for (let x = (grid.x - 1); x <= (grid.x + 1); x++) {
                  for (let y = (grid.y - 1); y <= (grid.y + 1); y++) {
                      if (typeof plots[x] != 'undefined' && typeof plots[x][y] != 'undefined')
                          continue;
                      highlightGrid({x: x, y: y}, null, 0, '');
                  }
              }
          }
          showingNeighbors = new Array();
      }
      
      function showFuturePlots(first_time) {
          let counter = 1;
          let max_plots = 100;
          if (!first_time && showingNeighbors.length)
              hideNeighbors();
          for (let i = 1; i <= max_plots; i++) {
              let nextorder = next_uplift + i;
              let found = cached_uplifts.find( ({ order }) => order == nextorder );
              if (found.asset_id != 0) {
                  max_plots++;
                  continue;
              }
              
              grid = locationToGrid(found.loc);
              
              let color = (counter == 1) ? '#00ff00' : '#00bb00';
              if (counter > show_next) color = null;
              let name = (counter == 1) ? 'Next Uplift' : 'Uplift After Next ';
              if (counter > 2) name += (counter - 1);
              
              let poptext = name + '<br>'
                  + 'Location: ' + (grid.x * 50) + ':' + (grid.y * 50) + '<br>'
                  + '<a href="https://worldmaps.theuplift.world/' + ((land == 'swine') ? 'Swineland#Swineland' : 'Boarvallis#Boarvallis') + ';flat;' + (grid.x * 50 + 25) + ',64,' + (grid.y * 50 + 25) + ';6">Live Map</a><br>'
                  + '<a href="javascript:showNeighbors({x: ' + grid.x + ',y:' + grid.y + '});">Wen Neighbor?</a>';
              highlightGrid(grid, color, counter, poptext);
              
              if (first_time && counter == 1) {
                  html = 'Next: <a href="javascript:panTo({x:' + grid.x + ', y:' + grid.y +'})">' + (grid.x * 50) + ':' + (grid.y * 50) + '</a>'
                       + '&nbsp Show: <select name="showselect" id="showselect"" onchange="change_showNext(this.value)">'
                       + '<option value="1">1</option>'
                       + '<option value="5">5</option>'
                       + '<option value="10">10</option>'
                       + '<option value="25">25</option>'
                       + '<option value="50">50</option>'
                       + '<option value="100">100</option>'
                       + '</select>'; 
                  document.getElementById('nextsale').innerHTML = html;
                  if (show_next != 1 && show_next != 5 && show_next != 10 && show_next != 25 && show_next != 50 && show_next != 100) {
                      var opt = document.createElement('option');
                      opt.appendChild(document.createTextNode(show_next));
                      opt.value = show_next;
                      document.getElementById('showselect').appendChild(opt);
                  }
                  document.getElementById('showselect').value = show_next;
              }
              
              counter++;
          }
      }
      
      function change_showNext(num) {
          set_showNext(num);
          document.getElementById('showselect').value = show_next;
          markerGroup.clearLayers();
          showFuturePlots();
      }
      
      function set_showNext(num) {
          num = parseInt(num);
          if (num < 1) num = 1;
          if (num > 100) num = 100;
          show_next = num;
          localStorage.setItem('show_next', show_next);
      }
      
      function processData(data) {
          for (let i = 0; i < data.length; i++) {
              coords = data[i].mutable_data.uplift_location.split(',');
              coords[0] = parseInt(coords[0]) / 50;
              coords[1] = parseInt(coords[1]) / 50;
              if( typeof plots[coords[0]] == 'undefined' ) plots[coords[0]] = new Array();
              plots[coords[0]][coords[1]] = data[i];
          }
                    
          for (let x = 1; x < plots.length; x++) {
              if (typeof plots[x] != 'undefined') {
                  for (let y = 1; y < plots[x].length; y++) {
                      if (typeof plots[x][y] != 'undefined') {
                          let plot = plots[x][y].data
                          let poptext = '<a href="javascript:highlightOwner(\'' + plots[x][y].owner + '\');">' + plots[x][y].owner + '</a><br>'
                               + 'NFT:&nbsp;<a href="https://wax.atomichub.io/explorer/asset/' + plots[x][y].asset_id + '">' +  plots[x][y].asset_id + '</a><br>'
                               +  plot.rarity.proper() + '&nbsp' + plot.mineral + '<br>'
                               + 'Location: ' + plot.uplift_location + '<br>'
                               + '<a href="https://worldmaps.theuplift.world/' + ((land == 'swine') ? 'Swineland#Swineland' : 'Boarvallis#Boarvallis') + ';flat;' + (x * 50 + 25) + ',64,' + (y * 50 + 25) + ';6">Live Map</a><br>'
                               + '<a href="javascript:showNeighbors({x: ' + x + ',y:' + y + '});">Wen Neighbor?</a>';
                          if( typeof gridlines[x] == 'undefined' ) gridlines[x] = new Array();
                          let mapcord = gridToMap({x: x, y: y});
                          gridlines[x][y] = L.rectangle([[mapcord.y, mapcord.x],[mapcord.y + plot_width, mapcord.x + plot_width]], {color: "#000000", weight: 5}).bindPopup(poptext).addTo(map);
                          if (typeof owners[plots[x][y].owner] === 'undefined') {
                              owners[plots[x][y].owner] = 1;
                          } else {
                              owners[plots[x][y].owner]++;
                          }
                      }
                  }
              }
          }
          
          html = '<span id="mapchoice">';
          if (land == 'swine')
              html += '<b>Swineland</b> | <a href="' + window.location.href.split('?')[0] + '?land=boar">Boarvallis</a></span>';
          else
              html += '<a href="' + window.location.href.split('?')[0] + '?land=swine">Swineland</a> | <b>Boarvallis</b></span>';

          html += 'Highlight Owner: <select name="owner" id="owner"" onchange="highlightOwner(this.value)">'
                +'<option value=""></option>'
          sortedowners = Object.keys(owners),
          sortedowners.sort();
          for (let i = 0; i < sortedowners.length; i++) {
              html += '<option value="' + sortedowners[i] + '">' + sortedowners[i] + ' (' + owners[sortedowners[i]] + ')</option>';
          }
          
          html += '</select><span id="lastsale">Loading future plots...</span><span id="saletimer"></span><span id="nextsale"></span>';
          document.getElementById('menu-bar').innerHTML = html;
        
        
    	  var queries = window.location.search.replace(/^\?/, '').split('&'), split;
    	  for( var i = 0; i < queries.length; i++ ) {
    	      split = queries[i].split('=');
    		  if (split[0] === 'owner') highlightOwner(split[1]);
              if (split[0] === 'showNext') {
                  set_showNext(split[1]);
              }
          }
          if (show_next === null) {
              show_next = localStorage.getItem('show_next');
              if (show_next === null) set_showNext(5);
          }
          
          fetchLastUplift();
      }
      
  </script>
</head>
<body>
    <div id="menu-bar">
        Loading NFT data....
    </div>
    <div id="image-map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script>
  	    var queries = window.location.search.replace(/^\?/, '').split('&'), split;
        var land = 'swine'
  	    for( var i = 0; i < queries.length; i++ ) {
  	        split = queries[i].split('=');
  		    if (split[0] === 'land' && split[1] == 'boar') land = 'boar';
        }
        
        var map = L.map('image-map', {
          minZoom: -1,
          maxZoom: 4,
          center: [1850, 100],
          zoom: 0,
          crs: L.CRS.Simple
        });

        var w = 2026,
            h = 2026,
            url = (land == 'swine') ? 'map.jpg' : 'map2.jpg',
        cached_uplifts = (land == 'swine') ? cached_swine_uplifts : cached_boar_uplifts;

        var bounds = new L.LatLngBounds([0,h], [w, 0]);
        L.imageOverlay(url, bounds).addTo(map);

        bounds = new L.LatLngBounds([-20,h+20], [w+80, -20]);
        map.setMaxBounds(bounds);
        
        var markerGroup = L.layerGroup().addTo(map);
    </script>
</body>
</html>