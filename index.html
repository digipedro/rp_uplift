<html>
<head>
  <meta charset="UTF-8" />
  <title>Uplift Swineland Plots</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <script src="cacheduplifts.js"></script>
  <!-- for testing <script src="testdata.js"></script> -->
  <style>
      #image-map {
          background: black;
          width: 100%;
          position: absolute;
          top: 3em; 
          bottom: 0;
      }
      #menu-bar {
          width: 100%;
          height: 3em;
          text-align: center;
      }
      #lastsale {
          margin-left: 3em;
      }
      #nextsale {
          margin-left: 3em;
      }
      .number-label {
          font-weight: bold;
          font-size: 2em;
          font-color: #00ff00;
          -webkit-text-fill-color: #00ff00;
          -webkit-text-stroke: 1px black;
      }
      body {
          margin-left: 0px;
      }
  </style>
  <script>
      var plots = new Array();
      var owners = new Object();
      var gridlines = new Array();
      var last_sale_date = 0;
      var show_next = 4;
      var sale_timer;
      
	  //var api_server = 'wax.greymass.com'
	  const api_server = 'wax.cryptolions.io'
      //var api_server = 'api.waxsweden.org'
      
      const map_offset_left = 24.0,
          map_offset_top = 23.1,
          plot_height = 25.0,
          plot_width = 25.03;
      
      function fetchNFTs() {
		  fetch("https://wax.api.atomicassets.io/atomicassets/v1/assets?collection_name=rplanet&schema_name=lands&page=1&limit=2000&mutable_data.uplift_world=Swineland")
		  .then(response => response.json())
          .then(data => processData(data.data))
	  	  .catch(error => {
              document.getElementById('menu-bar').innerHTML = 'Failed to fetch data from Atomic Assest API. Try again when they fix their shit. (' + error + ')';
	  	  });
      }
      
      async function fetchLastUplift() {
          var deltas;
		  await fetch("https://" + api_server + "/v2/history/get_deltas?code=l.rplanet&scope=l.rplanet&table=uplift")
		  .then(response => response.json())
          .then(data => deltas = data.deltas)
	  	  .catch(error => {
              console.log('Failed to fetch data from Cryptolions API - ' + error);
	  	  });
          processNew(deltas);
      }

      function fetchUplifts() {
		  fetch("https://" + api_server + "/v1/chain/get_table_rows", {
		    "headers": {
		      "accept": "*/*",
		      "accept-language": "en-US,en;q=0.9",
		      "content-type": "text/plain;charset=UTF-8",
		      "sec-ch-ua": "\"Google Chrome\";v=\"89\", \"Chromium\";v=\"89\", \";Not A Brand\";v=\"99\"",
		      "sec-ch-ua-mobile": "?0",
		      "sec-fetch-dest": "empty",
		      "sec-fetch-mode": "cors",
		      "sec-fetch-site": "cross-site"
		    },
		    "referrerPolicy": "strict-origin-when-cross-origin",
		    "body": '{"json":true,"code":"l.rplanet","scope":"l.rplanet","table":"uplift","lower_bound":"14173392078600","upper_bound":"","index_position":1,"key_type":"","limit":6000,"reverse":false,"show_payer":false}',
		    "method": "POST",
		    "mode": "cors",
		    "credentials": "omit" })
		  .then(response => response.json())
          .then(data => console.log(data))
	  	  .catch(error => {
              document.getElementById('menu-bar').innerHTML = 'Failed to fetch data for new sales. Try again when WAX fixes their shit. (' + error + ')';
	  	  });
      }

      String.prototype.proper = function() {
          return this.charAt(0).toUpperCase() + this.slice(1);
      }
      
      window.onload = async function() {
          fetchNFTs();
          // for testing
          //processData(raw_asset.data);
      };
      
      function highlightOwner(owner) {
          window.history.replaceState({ additionalInformation: 'Filter for owner' }, 'Uplift Swineland Plots', window.location.href.split('?')[0] + '?owner=' + encodeURIComponent(owner));
          for (let i = 1; i < plots.length; i++) {
              if (typeof plots[i] != 'undefined') {
                  for (let j = 1; j < plots[i].length; j++) {
                       if (typeof plots[i][j] != 'undefined') {
                           if (plots[i][j].owner == owner) {
                               gridlines[i][j].setStyle({ color: "#ffff00" }).bringToFront();
                           } else {
                               gridlines[i][j].setStyle({ color: "#000000" }).bringToBack();
                           }
                       }
                   }
               }
           }
      }
      
      function timeSince(date) {
          var seconds = Math.floor((new Date() - last_sale_date) / 1000);
          var interval = seconds / 31536000;
          var msg = Math.floor(interval) + " years ago";
          if (interval <= 1) {
              interval = seconds / 2592000;
              if (interval > 1) {
                msg = Math.floor(interval) + " months ago";
              } else {
                  interval = seconds / 86400;
                  if (interval > 1) {
                    msg = Math.floor(interval) + " days ago";
                  } else {
                      interval = seconds / 3600;
                      if (interval > 1) {
                        msg = Math.floor(interval) + " hours ago";
                      } else {
                          interval = seconds / 60;
                          if (interval > 1) {
                            msg = Math.floor(interval) + " minutes ago";
                          } else {
                              msg = "Less that 1 minute ago";
                          }
                      }
                  }
              }
          }
          document.getElementById('saletimer').innerHTML = '&nbsp;(' + msg + ')';
      }
      
      function locationToGrid(location) {
          location = parseInt(location);
          let y = Math.floor(location / 214748364800);
          let x = (location - y * 214748364800) / 50;
          return {x : x, y: y};
      }
      
      function gridToMap(grid) {
          let xx = (grid.x - 1) * plot_width + map_offset_left;
          let yy = (79 - grid.y) * plot_width + map_offset_top;
          return {x : xx, y: yy};
      }
      
      function highlightGrid(grid, color, number, poptext) {
          let mapcord = gridToMap(grid)
          
          if( typeof gridlines[grid.x] == 'undefined' ) gridlines[grid.x] = new Array();
          gridlines[grid.x][grid.y] = L.rectangle([[mapcord.y, mapcord.x],[mapcord.y+plot_width, mapcord.x+plot_width]], {color: color, weight: 5}).bindPopup(poptext).addTo(map);
          
          var myIcon = L.divIcon({className: 'number-label', html: number});
          L.marker([mapcord.y+plot_width+10, mapcord.x+plot_width+5], {icon: myIcon}).addTo(map);
      }
      
      function processNew(data) {
          var html = "";
          last_sale_date = new Date(data[0].timestamp + 'Z');
          let grid = locationToGrid(data[0].data.loc);
          let mapcord = gridToMap(grid);
          html += 'Newest: <a href="javascript:map.panTo(new L.LatLng('+mapcord.y+','+mapcord.x+'));">' + (grid.x * 50) + ':' + (grid.y * 50) + '</a>';
          document.getElementById('lastsale').innerHTML = html;
          timeSince();
          sale_timer = setInterval(timeSince, 10000);
          
          let counter = 1;
          for (let i = 1; i <= show_next; i++) {
              let nextorder = data[0].data.order + i;
              let found = cached_uplifts.find( ({ order }) => order == nextorder );
              if (found.asset_id != 0) {
                  show_next++;
                  continue;
              }
              let color = (counter == 1) ? '#00ff00' : '#00bb00';
              let name = (counter == 1) ? 'Next Uplift' : 'Uplift After Next';
              if (counter > 2) name += (counter - 1);
              
              grid = locationToGrid(found.loc);
              let poptext = name + '<br>'
                  + 'Location: ' + (grid.x * 50) + ':' + (grid.y * 50) + '<br>'
                  + '<a href="https://worldmaps.theuplift.world/Swineland#Swineland;flat;' + (grid.x * 50 + 25) + ',64,' + (grid.y * 50 + 25) + ';6">Live Map</a><br>';
              highlightGrid(grid, color, counter, poptext);
              
              if (counter == 1) {
                  mapcord = gridToMap(grid);
                  html = 'Next: <a href="javascript:map.panTo(new L.LatLng('+mapcord.y+','+mapcord.x+'));">' + (grid.x * 50) + ':' + (grid.y * 50) + '</a>';
                  document.getElementById('nextsale').innerHTML = html;
              }
              counter++;
          }
      }
      
      function processData(data) {
          for (let i = 0; i < data.length; i++) {
              coords = data[i].mutable_data.uplift_location.split(',');
              coords[0] = parseInt(coords[0]) / 50;
              coords[1] = parseInt(coords[1]) / 50;
              if( typeof plots[coords[1]] == 'undefined' ) plots[coords[1]] = new Array();
              plots[coords[1]][coords[0]] = data[i];
          }
                    
          for (let i = 1; i < plots.length; i++) {
              if (typeof plots[i] != 'undefined') {
                  for (let j = 1; j < plots[i].length; j++) {
                      if (typeof plots[i][j] != 'undefined') {
                          let x = (j - 1) * plot_width + map_offset_left;
                          let y = (79 - i) * plot_width + map_offset_top;
                          let plot = plots[i][j].data
                          let poptext = '<a href="javascript:highlightOwner(\'' + plots[i][j].owner + '\');">' + plots[i][j].owner + '</a><br>'
                               + 'NFT:&nbsp;<a href="https://wax.atomichub.io/explorer/asset/' + plots[i][j].asset_id + '">' +  plots[i][j].asset_id + '</a><br>'
                               +  plot.rarity.proper() + '&nbsp' + plot.mineral + '<br>'
                               + 'Location: ' + plot.uplift_location + '<br>'
                               + '<a href="https://worldmaps.theuplift.world/Swineland#Swineland;flat;' + (j * 50 + 25) + ',64,' + (i * 50 + 25) + ';6">Live Map</a><br>';
                          if( typeof gridlines[i] == 'undefined' ) gridlines[i] = new Array();
                          gridlines[i][j] = L.rectangle([[y, x],[y+plot_width, x+plot_width]], {color: "#000000", weight: 5}).bindPopup(poptext).addTo(map);
                          if (typeof owners[plots[i][j].owner] === 'undefined') {
                              owners[plots[i][j].owner] = 1;
                          } else {
                              owners[plots[i][j].owner]++;
                          }
                      }
                  }
              }
          }
          
          html = 'Highlight Owner: <select name="owner" id="owner"" onchange="highlightOwner(this.value)">'
                +'<option value=""></option>'
          sortedowners = Object.keys(owners),
          sortedowners.sort();
          for (let i = 0; i < sortedowners.length; i++) {
              html += '<option value="' + sortedowners[i] + '">' + sortedowners[i] + ' (' + owners[sortedowners[i]] + ')</option>';
          }
          html += '</select><span id="lastsale"></span><span id="saletimer"></span><span id="nextsale"></span>';
          document.getElementById('menu-bar').innerHTML = html;
        
    	  var queries = window.location.search.replace(/^\?/, '').split('&'), split;
    	  for( var i = 0; i < queries.length; i++ ) {
    	      split = queries[i].split('=');
    		  if (split[0] === 'owner') highlightOwner(split[1]);
              if (split[0] === 'showNext') {
                  show_next = parseInt(split[1]);
                  if (show_next < 1) show_next = 1;
                  if (show_next > 100) show_next = 100;
              }
          }
          
          fetchLastUplift();
      }
      
  </script>
</head>
<body>
    <div id="menu-bar">
        Loading NFT data....
    </div>
    <div id="image-map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script>
        var map = L.map('image-map', {
          minZoom: -1,
          maxZoom: 4,
          center: [1850, 100],
          zoom: 0,
          crs: L.CRS.Simple
        });

        var w = 2026,
            h = 2026,
            url = 'map.png';

        var bounds = new L.LatLngBounds([0,h], [w, 0]);
        L.imageOverlay(url, bounds).addTo(map);

        bounds = new L.LatLngBounds([-20,h+20], [w+80, -20]);
        map.setMaxBounds(bounds);
    </script>
</body>
</html>