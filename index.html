<html>
<head>
  <meta charset="UTF-8" />
  <title>Uplift Swineland Plots</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <script src="cacheduplifts.js"></script>
  <!-- for testing <script src="testdata.js"></script> -->
  <style>
      #image-map {
          background: black;
          width: 100%;
          position: absolute;
          top: 3em; 
          bottom: 0;
      }
      #menu-bar {
          width: 100%;
          height: 3em;
          text-align: center;
      }
      #lastsale {
          margin-left: 3em;
      }
      body {
          margin-left: 0px;
      }
  </style>
  <script>
      var plots = new Array();
      var owners = new Object();
      var gridlines = new Array();
	  //var api_server = 'wax.greymass.com'
	  const api_server = 'wax.cryptolions.io'
      //var api_server = 'api.waxsweden.org'
      
      const map_offset_left = 24.0,
          map_offset_top = 23.1,
          plot_height = 25.0,
          plot_width = 25.03;
      
      function fetchNFTs() {
		  fetch("https://wax.api.atomicassets.io/atomicassets/v1/assets?collection_name=rplanet&schema_name=lands&page=1&limit=2000&mutable_data.uplift_world=Swineland")
		  .then(response => response.json())
          .then(data => processData(data.data))
	  	  .catch(error => {
              document.getElementById('menu-bar').innerHTML = 'Failed to fetch data from Atomic Assest API. Try again when they fix their shit. (' + error + ')';
	  	  });
      }
      
      async function fetchLastUplift() {
          var deltas;
		  await fetch("https://" + api_server + "/v2/history/get_deltas?code=l.rplanet&scope=l.rplanet&table=uplift")
		  .then(response => response.json())
          .then(data => deltas = data.deltas)
	  	  .catch(error => {
              console.log('Failed to fetch data from Cryptolions API - ' + error);
	  	  });
          processNew(deltas);
      }

      function fetchUplifts() {
		  fetch("https://" + api_server + "/v1/chain/get_table_rows", {
		    "headers": {
		      "accept": "*/*",
		      "accept-language": "en-US,en;q=0.9",
		      "content-type": "text/plain;charset=UTF-8",
		      "sec-ch-ua": "\"Google Chrome\";v=\"89\", \"Chromium\";v=\"89\", \";Not A Brand\";v=\"99\"",
		      "sec-ch-ua-mobile": "?0",
		      "sec-fetch-dest": "empty",
		      "sec-fetch-mode": "cors",
		      "sec-fetch-site": "cross-site"
		    },
		    "referrerPolicy": "strict-origin-when-cross-origin",
		    "body": '{"json":true,"code":"l.rplanet","scope":"l.rplanet","table":"uplift","lower_bound":"14173392078600","upper_bound":"","index_position":1,"key_type":"","limit":6000,"reverse":false,"show_payer":false}',
		    "method": "POST",
		    "mode": "cors",
		    "credentials": "omit" })
		  .then(response => response.json())
          .then(data => console.log(data))
	  	  .catch(error => {
              document.getElementById('menu-bar').innerHTML = 'Failed to fetch data for new sales. Try again when WAX fixes their shit. (' + error + ')';
	  	  });
      }

      String.prototype.proper = function() {
          return this.charAt(0).toUpperCase() + this.slice(1);
      }
      
      window.onload = async function() {
          fetchNFTs();
          // for testing
          //processData(raw_asset.data);
      };
      
      function highlightOwner(owner) {
          window.history.replaceState({ additionalInformation: 'Filter for owner' }, 'Uplift Swineland Plots', window.location.href.split('?')[0] + '?owner=' + encodeURIComponent(owner));
          for (let i = 1; i < plots.length; i++) {
              if (typeof plots[i] != 'undefined') {
                  for (let j = 1; j < plots[i].length; j++) {
                       if (typeof plots[i][j] != 'undefined') {
                           if (plots[i][j].owner == owner) {
                               gridlines[i][j].setStyle({ color: "#ffff00" }).bringToFront();
                           } else {
                               gridlines[i][j].setStyle({ color: "#000000" }).bringToBack();
                           }
                       }
                   }
               }
           }
      }
      
      function timeSince(date) {
        var seconds = Math.floor((new Date() - date) / 1000);
        var interval = seconds / 31536000;
        if (interval > 1) {
          return Math.floor(interval) + " years ago";
        }
        interval = seconds / 2592000;
        if (interval > 1) {
          return Math.floor(interval) + " months ago";
        }
        interval = seconds / 86400;
        if (interval > 1) {
          return Math.floor(interval) + " days ago";
        }
        interval = seconds / 3600;
        if (interval > 1) {
          return Math.floor(interval) + " hours ago";
        }
        interval = seconds / 60;
        if (interval > 1) {
          return Math.floor(interval) + " minutes ago";
        }
        return "Less that 1 minute ago";
      }
      
      function highlightGrid(x, y, color, poptext) {
          let xx = (x - 1) * plot_width + map_offset_left;
          let yy = (79 - y) * plot_width + map_offset_top;
          
          if( typeof gridlines[x] == 'undefined' ) gridlines[x] = new Array();
          gridlines[x][y] = L.rectangle([[yy, xx],[yy+plot_width, xx+plot_width]], {color: color, weight: 5}).bindPopup(poptext).addTo(map);          
      }
      
      function processNew(data) {
          //var html = "";
          //html += 'Newest: ' + timeSince(Date(data[0].timestamp));
          //document.getElementById('lastsale').innerHTML = html;
          
          for (let i = 1; i < 5; i++) {
              let nextorder = data[0].data.order + i;
              let found = cached_uplifts.find( ({ order }) => order == nextorder );
              let location = parseInt(found.loc)
              let color = '#00ff00';
              let name = 'Next Uplift'
              if (i == 2) {
                  color = '#00aa00';
                  name = 'Uplift After Next (+1)'
              } else if (i == 3) {
                  color = '#006600';
                  name = 'Uplift After Next 2 (+2)'
              } else if (i == 4) {
                  color = '#006600';
                  name = 'Uplift After Next 3 (+3)'
              }
              y = Math.floor(location / 214748364800);
              x = (location - y * 214748364800) / 50;
              let poptext = name + '<br>'
                  + 'Location: ' + (x * 50) + ':' + (y * 50) + '<br>'
                  + '<a href="https://worldmaps.theuplift.world/Swineland#Swineland;flat;' + (x * 50 + 25) + ',64,' + (y * 50 + 25) + ';6">Live Map</a><br>';
              highlightGrid(x, y, color, poptext);
          }
      }
      
      function processData(data) {
          for (let i = 0; i < data.length; i++) {
              coords = data[i].mutable_data.uplift_location.split(',');
              coords[0] = parseInt(coords[0]) / 50;
              coords[1] = parseInt(coords[1]) / 50;
              if( typeof plots[coords[1]] == 'undefined' ) plots[coords[1]] = new Array();
              plots[coords[1]][coords[0]] = data[i];
          }
                    
          for (let i = 1; i < plots.length; i++) {
              if (typeof plots[i] != 'undefined') {
                  for (let j = 1; j < plots[i].length; j++) {
                      if (typeof plots[i][j] != 'undefined') {
                          let x = (j - 1) * plot_width + map_offset_left;
                          let y = (79 - i) * plot_width + map_offset_top;
                          let plot = plots[i][j].data
                          let poptext = plots[i][j].owner + '<br>'
                               + 'NFT:&nbsp;<a href="https://wax.atomichub.io/explorer/asset/' + plots[i][j].asset_id + '">' +  plots[i][j].asset_id + '</a><br>'
                               +  plot.rarity.proper() + '&nbsp' + plot.mineral + '<br>'
                               + 'Location: ' + plot.uplift_location + '<br>'
                               + '<a href="https://worldmaps.theuplift.world/Swineland#Swineland;flat;' + (j * 50 + 25) + ',64,' + (i * 50 + 25) + ';6">Live Map</a><br>';
                          if( typeof gridlines[i] == 'undefined' ) gridlines[i] = new Array();
                          gridlines[i][j] = L.rectangle([[y, x],[y+plot_width, x+plot_width]], {color: "#000000", weight: 5}).bindPopup(poptext).addTo(map);
                          if (typeof owners[plots[i][j].owner] === 'undefined') {
                              owners[plots[i][j].owner] = 1;
                          } else {
                              owners[plots[i][j].owner]++;
                          }
                      }
                  }
              }
          }
          
          html = 'Highlight Owner: <select name="owner" id="owner"" onchange="highlightOwner(this.value)">'
                +'<option value=""></option>'
          sortedowners = Object.keys(owners),
          sortedowners.sort();
          for (let i = 0; i < sortedowners.length; i++) {
              html += '<option value="' + sortedowners[i] + '">' + sortedowners[i] + ' (' + owners[sortedowners[i]] + ')</option>';
          }
          html += '</select><span id="lastsale"></span>';
          document.getElementById('menu-bar').innerHTML = html;
        
    	  var queries = window.location.search.replace(/^\?/, '').split('&'), split;
    	  for( var i = 0; i < queries.length; i++ ) {
    	      split = queries[i].split('=');
    		  if (split[0] === 'owner') highlightOwner(split[1]);
          }
          
          fetchLastUplift();
      }
      
  </script>
</head>
<body>
    <div id="menu-bar">
        Loading NFT data....
    </div>
    <div id="image-map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script>
        var map = L.map('image-map', {
          minZoom: -1,
          maxZoom: 4,
          center: [1850, 100],
          zoom: 0,
          crs: L.CRS.Simple
        });

        var w = 2026,
            h = 2026,
            url = 'map.png';

        var bounds = new L.LatLngBounds([0,h], [w, 0]);
        L.imageOverlay(url, bounds).addTo(map);

        bounds = new L.LatLngBounds([-20,h+20], [w+80, -20]);
        map.setMaxBounds(bounds);
    </script>
</body>
</html>